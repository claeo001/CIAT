name: pull request

on:
  push:
    branches:
      - develop
      - master
  pull_request:
    branches:
      - "**"

jobs:
  docker:
    timeout-minutes: 10
    runs-on: ubuntu-latest

    steps:
      # í•´ë‹¹ ì €ì¥ì†Œì˜ ì½”ë“œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
      - name: Checkout
        uses: actions/checkout@v2

      # docker-composeë¥¼ í™œìš©í•´ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•œ ì»¨í…Œì´ë„ˆ í™˜ê²½ì„ êµ¬ì„±í•©ë‹ˆë‹¤.
      - name: Start containers
        run: docker-compose -f "docker-compose.yml" up -d --build

      # Node 16 ë²„ì „ì„ ì‚¬ìš©í•©ë‹ˆë‹¤.
      - name: Install node
        uses: actions/setup-node@v2
        with:
          node-version: '16'
          cache: 'npm'

      # yarnì„ ì„¤ì¹˜í•©ë‹ˆë‹¤.
      - name: Install Yarn
        run: npm install yarn

      # ì„¤ì¹˜ëœ yarnì„ í†µí•´ íŒ¨í‚¤ì§€ë¥¼ ì„¤ì¹˜í•©ë‹ˆë‹¤.
      - name: Install dependencies
        run: yarn install

      # í…ŒìŠ¤íŠ¸ ìˆ˜í–‰ê³¼ ê·¸ í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ xmlíŒŒì¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤.
      - name: Run tests
        run: yarn test:report

      # í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ ë‹´ì€ xml íŒŒì¼ì„ ë ˆí¬íŠ¸ë¡œ ë³€í™˜í•©ë‹ˆë‹¤.
      - name: Test Report
        uses: dorny/test-reporter@v1
        if: success() || failure()    # run this step even if previous step failed
        with:
          name: test-results
          path: junit.xml
          fail-on-error: 'false'
          reporter: jest-junit        # Format of test results
          token: ${{ secrets.GITHUB_TOKEN }}

      # ì•ì˜ ì‘ì—…ì´ ì‹¤íŒ¨/ì„±ê³µê³¼ ê´€ê³„ ì—†ì´ ì»¨í…Œì´ë„ˆë“¤ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.
      - name: Stop containers
        if: always()
        run: docker-compose -f "docker-compose.yml" down
          
      - name: Discord Alert Success
        uses: sarisia/actions-status-discord@v1
        if: success()
        with:
          webhook: ${{ secrets.DISCORD_WEBHOOK }}
          description: "ğŸ‰ í…ŒìŠ¤íŠ¸ ë˜ì—ˆìŠµë‹ˆë‹¤!"

      - name: Discord Alert Failure
        uses: sarisia/actions-status-discord@v1
        if: failure()
        with:
            webhook: ${{ secrets.DISCORD_WEBHOOK }}
            description: "ğŸ”¥ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤íŒ¨í•˜ì˜€ìŠµë‹ˆë‹¤."     
          

  

